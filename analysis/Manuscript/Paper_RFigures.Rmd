---
title: "Plot Figures for McDuffie et al., 2023 (those generated in R)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "~/CCD-CSIB/GitHub/Code/MOMM-RFT")
```

```{r libraries, include = FALSE}
library('tidyverse')
library('reshape2')
library('patchwork')
library('RColorBrewer')
library('maps')
library('mapproj')
library('arrow')
library('readxl')
library('zoo')
```

# Figures

##Figure S1

Time series of global methane and O3 mixing ratios, by GCM
```{r FigureS1}

#specify input and output paths
Plots <-file.path(getwd(),'analysis','Manuscript','Plots')
Input <- file.path(getwd(),'analysis','Manuscript','BenMAP','Inputs')

#Define BenMAP years and create dataframes
Model.years<-c(2020,2025,2030,2035,2040,2050,2060,2070,2080,2090,2100)
s1Data_methane <- data.frame(Model.years)
s1Data_ozone <- data.frame(Model.years)

#Read in the globally averaged mean O3 response data
# Generated by /analysis/Manuscript/BenMAP/Inputs/Generate AQ Surfaces for BenMAP.R
All.mean.results <- read.csv(file.path(Input,"AQ Surfaces","Mean_Pulse_Data.csv"))


#pull out the methane data for each year (note, bad practice to reference by index - change later)
# the model name, and calculate the change in O3 between the baseline and perturbed scenarios
for (iyear in 1:length(Model.years)){
  s1Data_methane$MethanePerturbed_ppbv[iyear] <- All.mean.results[1,7+iyear]
  s1Data_ozone$CESM2[iyear]  <- All.mean.results[All.mean.results$Model =='CESM2',18+iyear]
  s1Data_ozone$GFDL[iyear]   <- All.mean.results[All.mean.results$Model =='GFDL',18+iyear]
  s1Data_ozone$GISS[iyear]   <- All.mean.results[All.mean.results$Model =='GISS',18+iyear]
  s1Data_ozone$HadGEM[iyear] <- All.mean.results[All.mean.results$Model =='HadGEM',18+iyear]
  s1Data_ozone$MIROC[iyear]  <- All.mean.results[All.mean.results$Model =='MIROC',18+iyear]
  s1Data_ozone$CESM2_delta[iyear] <- 
    s1Data_ozone$CESM2[iyear] - All.mean.results[All.mean.results$Model =='CESM2','Values.base'] #subtract baseline
  s1Data_ozone$GFDL_delta[iyear] <- 
    s1Data_ozone$GFDL[iyear] - All.mean.results[All.mean.results$Model =='GFDL','Values.base'] #subtract baseline
  s1Data_ozone$GISS_delta[iyear] <- 
    s1Data_ozone$GISS[iyear] - All.mean.results[All.mean.results$Model =='GISS','Values.base'] #subtract baseline
  s1Data_ozone$HadGEM_delta[iyear] <- 
    s1Data_ozone$HadGEM[iyear] - All.mean.results[All.mean.results$Model =='HadGEM','Values.base'] #subtract baseline
  s1Data_ozone$MIROC_delta[iyear] <- 
    s1Data_ozone$MIROC[iyear] - All.mean.results[All.mean.results$Model =='MIROC','Values.base'] #subtract baseline
}

s1Data_ozonelong <- reshape2::melt(s1Data_ozone, id="Model.years")

# Perturbed Methane timeseries
p1 <- ggplot(s1Data_methane,aes(x=Model.years,y=MethanePerturbed_ppbv, color = "Methane"))+
  geom_hline(aes(yintercept = 1834, linetype = "Baseline"), show.legend =FALSE)+
  geom_line()+
  geom_point()+
  scale_y_continuous(name="Methane Mixing Ratio [ppbv]")+
  labs(x='Year',y = "Methane Mixing Ratio [ppbv]", color="")+
  scale_x_continuous(breaks=seq(2020,2100,10))+
  ggtitle('Annual Methane')+
  theme_minimal()+
  theme(legend.position = 'bottom',
        axis.text.x=element_text(angle=45,hjust=1, vjust=1))+
  scale_color_manual(name='', values = c('black','black'))+
  scale_linetype_manual(name = '', values=c(Baseline = 'dashed'))
  #p1
  
#ozone perturbation with baseline
p2 <- s1Data_ozonelong %>%
  filter(!grepl('delta', variable)) %>%
  ggplot(aes(x=Model.years,y=value, color = variable))+
  scale_y_continuous(name="Ozone Mixing Ratio [ppbv]", limits = c(27, 31))+
  labs(x='Year',y = "Ozone Mixing Ratio [ppbv]", color="")+
  scale_x_continuous(breaks=seq(2020,2100,10))+
  geom_hline(aes(yintercept = All.mean.results$Values.base[1], linetype = "Baseline"), 
             show.legend =FALSE)+
  geom_hline(aes(yintercept = All.mean.results$Values.base[2], linetype = "Baseline"), 
             show.legend =FALSE)+
  geom_hline(aes(yintercept = All.mean.results$Values.base[3], linetype = "Baseline"), 
             show.legend =FALSE)+
  geom_hline(aes(yintercept = All.mean.results$Values.base[4], linetype = "Baseline"), 
             show.legend =FALSE)+
  geom_hline(aes(yintercept = All.mean.results$Values.base[5], linetype = "Baseline"), 
             show.legend =FALSE)+
  geom_line()+
  geom_point()+
  ggtitle('Summertime MDA8'~O[3])+
  theme_minimal()+
  theme(legend.position = 'bottom',
        axis.text.x=element_text(angle=45,hjust=1, vjust=1))+
  guides(color=guide_legend(ncol=3))+
  scale_colour_manual(values=c(brewer.pal(11,"Spectral")[c(1,4,9:11)]))+
  scale_linetype_manual(name = '', values=c(Baseline = 'dashed'))

#p2
p3<- p1+p2
p3 <-p3+plot_annotation(title = "Methane & Ozone Mixing Ratios in Response to a 2020 Pulse of Methane")

ggsave(plot = p3, filename = 
         file.path(Plots,'FigS1_wbackground.png'),width = 8,height = 5)
p3

#ozone perturbation without baseline
p2 <- s1Data_ozonelong %>%
  filter(grepl('delta', variable)) %>%
  mutate(value = value*1000) %>% #convert to pptv
  ggplot(aes(x=Model.years,y=value, color = variable))+
  scale_y_continuous(name="Ozone Mixing Ratio [pptv]", limits = c(0,400))+
  labs(x='Year',y = "Ozone Mixing Ratio [pptv]", color="")+
  scale_x_continuous(breaks=seq(2020,2100,10))+
  geom_hline(aes(yintercept = 0, linetype = "Baseline"), show.legend =FALSE)+
  geom_line()+
  geom_point()+
  ggtitle('Summertime Delta MDA8'~O[3])+
  theme_minimal()+
  theme(legend.position = 'bottom',
        axis.text.x=element_text(angle=45,hjust=1, vjust=1))+
  guides(color=guide_legend(ncol=3))+
  scale_colour_manual(values=c(brewer.pal(11,"Spectral")[c(1,4,9:11)]))+
  scale_linetype_manual(name = '', values=c(Baseline = 'dashed'))

p4<- p1+p2
p4 <-p4+plot_annotation(title = "Methane & Delta Ozone Mixing Ratios in Response to a 2020 Pulse of Methane")

ggsave(plot = p4, filename = 
         file.path(Plots,'FigS1.png'),width = 8,height = 5)
p4

```

##Figure S3

Time series of population characteristics 
```{r popcharacteristics}

#define paths
Plots <-file.path('analysis','Manuscript','Plots') 
inputs <- file.path("analysis","Manuscript")
inputs2 <- file.path('input','RFF','lookup_tables')
inputs3 <- file.path("input")
Inputs_socio <- file.path('input','RFF','rft_inputs')

#Read in RFF-SP data
# Pre-processed in /code/1_build_inputs_for_momm_rft.R
rffsp <- read_parquet(file.path(Inputs_socio, 'rffsp_pop_gdp_all_trials.parquet'))

rffsp_mean_pop <- rffsp %>%
  select(-c('dollar.year','gdp')) %>%
  group_by_at(.vars = c('Year','Country')) %>% #sum across trials for each country
  summarise_at(.vars = c('pop'), mean) %>%
  ungroup() %>%
  #interpolate between 5 year intervals
  group_by(Country) %>%
  complete(Year=min(Year):max(Year))%>%
  mutate(pop = approx(x=Year,y=pop,xout=2020:2100)$y)

rffsp_global_all_pop <- rffsp %>%
  group_by_at(.vars = c('Year','trial')) %>% #sum across countries
  summarise_at(.vars = c('pop'), sum) %>%
  ungroup() %>%
  group_by_at(.vars = c('trial')) %>%
  complete(Year=min(Year):max(Year))%>%
  mutate(pop = approx(x=Year,y=pop,xout=2020:2100)$y) %>%
  ungroup

p1 <-  rffsp_global_all_pop %>%
        group_by(Year) %>% 
        mutate(pop = pop/1e9) %>%
        summarize(X025=quantile(pop,probs=0.025), 
            X50=quantile(pop, probs=0.50),
            X975=quantile(pop,probs=0.975),
            X005=quantile(pop,probs=0.005),
            X995=quantile(pop,probs=0.995),
            mean=mean(pop)) %>% ungroup %>%
        na.omit() %>%
      ggplot()+
        geom_ribbon(aes(x=Year, 
                        ymin = X005, 
                        ymax = X995, 
                        fill="99th% Confidence Interval"), 
                    alpha=0.3) +
        geom_ribbon(aes(x=Year, 
                        ymin = X025, 
                        ymax = X975, 
                        fill = "95th% Confidence Interval"), 
                    alpha=0.9) +
        geom_line(aes(x=Year, y=mean,color="Mean"), size = 1)+
        scale_linetype_manual(values=c(rep("solid",5),"solid","longdash"))+
        scale_colour_manual("",values = c("95th% Confidence Interval" = 'darkgray',
                                        "99th% Confidence Interval" ='lightgray',
                                        "Mean" = "red"))+
        scale_fill_manual("",values = c("95th% Confidence Interval" = 'darkgray',
                                        "99th% Confidence Interval" ='lightgray',
                                        "Mean" = "tranparent"))+
        xlab("Year")+ylab("Population (billions)")+
        theme_minimal()+
        scale_x_continuous(breaks=seq(2020,2100,10))+
        theme(legend.position = c(0.3,0.9),
              legend.title=element_text(size=16), 
              legend.text=element_text(size=16),
              legend.spacing.y = unit(-0.45, 'cm'))+
        theme(axis.text = element_text(size=16),
              axis.title = element_text(size=16))#+
p1

ggsave(plot = p1, filename = 
         file.path(Plots,'Timeseries_global_population.png'),width = 8,height = 5)

####### Respiratory Mortality Rate & Population #############

#IF Data on ratios of respiratory to total mortality rates
IFsFactors<-read.csv(file.path(inputs3,'IFP',"adjustment_factors.csv"))  
IFsCountry<-read.csv(file.path(inputs3,'IFP',"country_codes.csv"))
  names(IFsCountry)[1] <- 'RegionName2'
IFsCtryCross<-read.csv(file.path(inputs3,'IFP',"country_crosswalk.csv"))
IFsFactors<-left_join(IFsFactors,IFsCountry,by=c("Region"="RegionNum"))
IFsFactors<-left_join(IFsFactors,IFsCtryCross,by=c("RegionName2"="IFsName"),multiple='all')
  names(IFsFactors)<-c("X","Years","Region","RFF_Age_range","final_AF",
                       "RegionName","LocID","RFFName","Notes")
IFsFactors<-IFsFactors[,2:8]
Cross.year<-read_xlsx(file.path(inputs3,'IFP','Crosswalk RFF Mort Year.xlsx'))
mean.pop<-read.csv(file.path(inputs,'RFF',"rff_pop_means.csv"))
#subset for relevant years (<2100)
mean.pop<-mean.pop[(mean.pop$Year<=2100),]
mean.pop <- mean.pop %>%
  filter(Year <= 2100) %>%
  mutate(mean_pop = mean_pop *1000) #convert to ppl counts

#calculate respiratory mortality counts (from rates * population)
mort_means <- read_csv(file.path(inputs,'RFF','rff_mort_means.csv'))
resp_mort_means <-left_join(mort_means,Cross.year,by=c("Year"="RFF year"))
resp_mort_means<-left_join(resp_mort_means,mean.pop,by=c("LocID","Min.Year"="Year","Age"))
resp_mort_means<-left_join(resp_mort_means,IFsFactors,by=c("LocID","Year"="Years",
                                                           "Age"="RFF_Age_range"))
#calculate mean resp mortality 
resp_mort_means$mean_resp_rate<-resp_mort_means$mean_mort_rate * resp_mort_means$final_AF
resp_mort_means<-resp_mort_means[(resp_mort_means$Min.Year<2100),]
resp_mort_means_noage<-resp_mort_means %>%
                       group_by(LocID,Min.Year) %>%
                       summarize(meanmort=weighted.mean(mean_resp_rate,mean_pop),.groups="keep") #population weighted rates
resp_mort_means_noage<-resp_mort_means_noage %>%
                        group_by(LocID) %>%
                        complete(Min.Year=min(Min.Year):max(Min.Year))%>%
                        mutate(MeanMortalityRate = na.approx(meanmort)) 
resp_mort_means_noage.2095<-resp_mort_means_noage[(resp_mort_means_noage$Min.Year==2095),]
resp_mort_means_noage.2095<-resp_mort_means_noage.2095 %>%
                                group_by(LocID) %>%
                                complete(Min.Year=c(2095:2100))%>%
                                fill(MeanMortalityRate,.direction="down")
#join 2095-2100 with rest of data (exclude 2095 from second table otherwise you'll have duplicates)
resp_mort_means_noage <-
  rbind(resp_mort_means_noage,
        resp_mort_means_noage.2095[(resp_mort_means_noage.2095$Min.Year>2095),])

#calculate global respiratory mortality counts for all scenarios
mort.files<-list.files(file.path(inputs2),
                       pattern = "All Trajectory Resp Mortality Ratios_AllAges_through 2100_")
All.mort<-lapply(file.path(file.path(inputs2),mort.files), readRDS)
resp_mort_ratios<-do.call(rbind,All.mort)
names(resp_mort_ratios)[5]<-"MortRatio"  #change Ratios to MortRatio so differs from pop column 
rm(mort.files,All.mort)
#it doesn't matter that the trajectory #s here are the mortality (not RFF) trajectory numbers. We are just taking the stats across all trials
      
resp_mort_ratios_comb <- left_join(resp_mort_ratios, 
                                   resp_mort_means_noage, 
                                   by = c("Year"="Min.Year","LocID"))

resp_mort_ratios_comb$MortRate = resp_mort_ratios_comb$MortRatio * 
  resp_mort_ratios_comb$MeanMortalityRate #get absolute rate for each trajectory


# #now need to calculate deaths to get global mortality rate
SampleID<-read.csv(file.path(inputs3,"sampled_pop_trajectory_numbers.csv"))
# #need to crosswalk RFF and mort trial #s
 Trajectory <- data.frame(rff_trial = c(1:10000),
                          mort_traj = SampleID$x)

Ctry.Name<-read.csv(file.path(inputs3,'Final Country Grid Col_Row Index.csv'))
 
 rffsp_mort <- rffsp %>%
   select('pop','Year','trial','Country') %>%
   left_join(Trajectory, by = c('trial'='rff_trial'))
 
 rffsp_mort2 <- rffsp_mort %>%
   select(-c(trial)) %>%
   distinct() %>%
   left_join(Ctry.Name, by = c('Country'='RFF_iso_code')) %>%
   select(c('pop','Year','mort_traj','COL')) %>%
   left_join(resp_mort_ratios_comb, by = c('COL'='LocID','Year','mort_traj'='Trajectory')) %>%
   select('Year','pop','mort_traj','COL','MortRate') #%>%

 
rffsp_mort3 <- rffsp_mort2 %>%
  mutate(mort = pop * MortRate) %>%
  group_by_at(.vars= c('Year','mort_traj')) %>%
  summarise_at(.vars= c("mort","pop"),sum, na.rm=T) %>% #sum across countries (not trials)
  ungroup %>%
  group_by(mort_traj) %>%
  complete(Year=min(Year):max(Year))%>%
  mutate(pop = approx(x=Year,y=pop,xout=2020:2100)$y,
         mort = approx(x=Year,y=mort,xout=2020:2100)$y) %>%
  mutate(global_rate = mort/pop)


p2 <-  rffsp_mort3 %>%
        group_by(Year) %>% 
        mutate(MortRate = global_rate*1e5) %>% #get per 100K rate
        summarize(X025=quantile(MortRate,probs=0.025), 
            X50=quantile(MortRate, probs=0.50),
            X975=quantile(MortRate,probs=0.975),
            X005=quantile(MortRate,probs=0.005),
            X995=quantile(MortRate,probs=0.995),
            mean=mean(MortRate)) %>% ungroup %>%
        na.omit() %>%
      ggplot()+
        geom_ribbon(aes(x=Year,
                        ymin = X005, 
                        ymax = X995, 
                        fill="99th% Confidence Interval"), 
                    alpha=0.3) +
        geom_ribbon(aes(x=Year, 
                        ymin = X025, 
                        ymax = X975, 
                        fill = "95th% Confidence Interval"), 
                    alpha=0.9) +
        geom_line(aes(x=Year, y=mean,color="Mean"), size = 1)+
        scale_linetype_manual(values=c(rep("solid",5),"solid","longdash"))+
        scale_colour_manual("",values = c("95th% Confidence Interval" = 'darkgray',
                                        "99th% Confidence Interval" ='lightgray',
                                        "Mean" = "red"))+
        scale_fill_manual("",values = c("95th% Confidence Interval" = 'darkgray',
                                        "99th% Confidence Interval" ='lightgray',
                                        "Mean" = "tranparent"))+
        xlab("Year")+ylab("Respiratory Mortality Rate (per 100K)")+
        theme_minimal()+
        scale_x_continuous(breaks=seq(2020,2100,10))+
        theme(legend.position = c(0.3,0.9),
              legend.title=element_text(size=16), 
              legend.text=element_text(size=16),
              legend.spacing.y = unit(-0.45, 'cm'))+
        theme(axis.text = element_text(size=16),
              axis.title = element_text(size=16))#+
p2

ggsave(plot = p2, filename = 
         file.path(Plots,'Timeseries_global_avgMortRate.png'),width = 8,height = 5)


p3<- p1+p2
p3 <-p3+plot_annotation(title = "Global Population & Mortality Rate Projections",
                        theme = theme(plot.title = element_text(size = 20)))

ggsave(plot = p3, filename = 
         file.path(Plots,'FigS3.png'),width = 14,height = 5)
p3

```


##Figures 2a, S4

Timeseries of Respiratory mortality counts, by GCM (Figure S4)
Time series of respiratory mortality, with beta uncertainties (Fig 2a)
```{r Global & Country TimeSeries}


#plot line graph of global total and top 10 countries (for MMM)
Plots <- file.path(getwd(),'analysis','Manuscript','BenMAP','Outputs')

# Processed BenMAP respiratory mortality output files
# from /analysis/Manuscript/BenMAP/Summarizing BenMAP Results.R
countryResults    <- read.csv(paste0(Plots,"/Country Results Summary by Model & Year.csv"))
globalResults     <- read.csv(paste0(Plots,"/Global Results Summary by Model & Year.csv"))
globalResults2.5  <- read.csv(paste0(Plots,"/Global Results Summary by Model & Year 2_5CI.csv"))
globalResults97.5 <- read.csv(paste0(Plots,"/Global Results Summary by Model & Year 97_5CI.csv"))

globalResultslong <- globalResults %>%
  select(-c('AvgResponse','TotalResults','TotalPct2_5','TotalPct97_5'))
globalResultslong <- reshape2::melt(globalResultslong, id="Model")
globalResultslong$Model.years <- strtoi(str_replace(globalResultslong$variable, 'X',''))

###### do same calcs for CIs
globalResults2.5long <- globalResults2.5 %>%
  select(-c('AvgResponse','TotalResults','TotalPct2_5','TotalPct97_5'))
globalResults2.5long <- reshape2::melt(globalResults2.5long, id="Model")
globalResults2.5long$Model.years <- strtoi(str_replace(globalResults2.5long$variable, 'X',''))

globalResults97.5long <- globalResults97.5 %>%
  select(-c('AvgResponse','TotalResults','TotalPct2_5','TotalPct97_5'))
globalResults97.5long <- reshape2::melt(globalResults97.5long, id="Model")
globalResults97.5long$Model.years <- strtoi(str_replace(globalResults97.5long$variable, 'X',''))

######
### Figure S4. 

p1 <-  ggplot(globalResultslong, aes(x=Model.years,y=value,colour=Model,group=Model,linetype=Model))+
        geom_point()+
        geom_line()+
        scale_linetype_manual(values=c(rep("solid",5),"solid","longdash"))+
        scale_colour_manual(values=c(brewer.pal(11,"Spectral")[c(1,4,9:11)],"black","gray"))+
        scale_size_manual(values=c(rep(1,5),1.5,1))+
        xlab("Year")+ylab("Annual Attributable Respiratory-Related Mortality (deaths)")+
        ggtitle('Annual Respiratory-Related Mortality Attributable to an Increase in \nMDA8 Ozone Exposure from a Methane Pulse in 2020')+
        theme_minimal()+
        scale_x_continuous(breaks=seq(2020,2100,10))+
        scale_y_continuous(limits=c(0,18000))
p1
ggsave(plot = p1, filename = 
         file.path(Plots,'Plots/Timeseries_O3Mort_GCMs.png'),width = 8,height = 5)


#### 

# ### Extra Fig for now ###
# #plot global MMM with uncertainty bounds (from GCM uncertainty)
# global_limits<- globalResultslong %>%
#   filter(Model %in% c('MMM - Mean AQS','MIROC','HadGEM')) %>%
#   spread(Model,value)
# p1_bounds <- global_limits %>%
#     ggplot(aes(x=Model.years,y=`MMM - Mean AQS`,ymin=MIROC, ymax=HadGEM,fill='MMM &\nGCM Distribution'))+
#         geom_point()+
#         geom_line()+
#         geom_ribbon(alpha=0.5) +
#         scale_linetype_manual(values="solid","longdash","longdash")+
#         scale_colour_manual('',values="black")+
#         scale_fill_manual("",values="gray50")+
#         scale_size_manual(values=c(rep(1,5),1.5,1))+
#         xlab("Year")+ylab("Deaths")+
#         ggtitle('Global Annual Respiratory-Related Ozone Attributable Mortality')+
#         theme_minimal()+
#         scale_x_continuous(breaks=seq(2020,2100,10))+
#         scale_y_continuous(limits=c(0,18000), labels=scales::comma)+
#         theme(legend.position = c(0.15, 0.15), legend.text = element_text(size=16))+
#         theme(axis.text = element_text(size=16),
#               axis.title = element_text(size=16),
#               axis.text.x=element_text(angle=45,hjust=1, vjust=1))
# p1_bounds
# ggsave(plot = p1_bounds, filename = 
#          file.path(Plots,'Plots/Timeseries_O3Mort_GCMbounds.png'),width = 9,height = 5)


## Figure 2a

#plot global MMM with uncertainty bounds (from CRF uncertainty)
global_limits<- globalResults2.5long %>%
  filter(Model %in% c('MMM - Mean AQS')) %>%
  mutate(Model = 'lower') %>%
  rbind(globalResults97.5long) %>%
  filter(Model %in% c('lower','MMM - Mean AQS')) %>%
  mutate(Model = case_when( Model == 'MMM - Mean AQS' ~ 'upper',TRUE ~ Model)) %>%
  #spread(Model,value) %>%
  #rename(upper = `MMM - Mean AQS`) %>%
  rbind(globalResultslong) %>%
  filter(Model %in% c('lower','upper','MMM - Mean AQS')) %>%
  spread(Model,value)
p1_bounds <- global_limits %>%
    ggplot(aes(x=Model.years,y=`MMM - Mean AQS`,ymin=lower, ymax=upper,fill='MMM &\nCRF Distribution'))+
        geom_point()+
        geom_line()+
        geom_ribbon(alpha=0.5) +
        scale_linetype_manual(values="solid","longdash","longdash")+
        scale_colour_manual('',values="black")+
        scale_fill_manual("",values="gray50")+
        scale_size_manual(values=c(rep(1,5),1.5,1))+
        xlab("Year")+ylab("Deaths")+
        ggtitle('Global Annual Respiratory-Related Ozone Attributable Mortality')+
        theme_minimal()+
        scale_x_continuous(breaks=seq(2020,2100,10))+
        scale_y_continuous(limits=c(0,18000), labels=scales::comma)+
        theme(legend.position = c(0.15, 0.15), legend.text = element_text(size=16))+
        theme(axis.text = element_text(size=16),
              axis.title = element_text(size=16),
              axis.text.x=element_text(angle=45,hjust=1, vjust=1))
p1_bounds
ggsave(plot = p1_bounds, filename = 
         file.path(Plots,'Plots/Timeseries_O3Mort_CRFbounds.png'),width = 9,height = 5)

###


# ### Extra
# ## Line plot timeseries of deaths in top 10 countries.
# cResultslong <- countryResults %>%
#   arrange(desc(TotalResults)) %>%
#   group_by(Model) %>%
#   slice(1:10) %>%
#   ungroup()%>%
#   filter(Model =='MMM') %>%
#   select(-c('AvgResponse','TotalResults','TotalPct2_5','TotalPct97_5','Model','Region','SuperRegion')) 
# 
# cResultslong <- reshape2::melt(cResultslong, id="COUNTRY")
# cResultslong$Model.years <- strtoi(str_replace(cResultslong$variable, 'X',''))
# globalMMM <- globalResultslong[globalResultslong$Model == 'MMM - Mean AQS',]
# globalMMM$COUNTRY <- 'Global'
# globalMMM <- globalMMM %>%
#   select(-c('Model'))
# cResultslong <- rbind(cResultslong, globalMMM)
#     
#   cou_i <- cResultslong %>% 
#   group_by_at(.vars=c("COUNTRY")) %>% 
#   #filter(Model.years == 2020) %>%
#   summarize_at(.vars=c("value"),sum,na.rm=T) %>%
#   ungroup %>% arrange(desc(value)) %>%
#   distinct(COUNTRY)
# 
#   cResultslong <- cResultslong %>% 
#   mutate(COUNTRY = COUNTRY %>% factor(levels = (cou_i$COUNTRY))) %>%
#   arrange_at(.vars=c("COUNTRY"))
# 
# p2 <-  ggplot(cResultslong, aes(x=Model.years,y=value,colour=COUNTRY,group=COUNTRY,linetype=COUNTRY))+
#         geom_point()+
#         geom_line()+
#         scale_linetype_manual(values=c(rep("solid",9),"solid","solid"))+
#         scale_colour_manual(values=c("black",brewer.pal(11,"Spectral")[c(1:3,5,7:11)],"gray"))+
#         scale_size_manual(values=c(rep(1,5),1.5,1))+
#         xlab("Year")+ylab("Annual Attributable Respiratory-Related Mortality (deaths)")+
#         ggtitle('Annual Respiratory-Related Ozone Attributable Mortality (MMM), \nTop 10 Countries')+
#         theme_minimal()+
#         scale_x_continuous(breaks=seq(2020,2100,10))+
#         scale_y_continuous(limits=c(0,11500))
# p2
# 
# ## Extra
# ### Line plot timeseries of mortality by super-region
# 
# #Plot Regional Results
# #calculate average regional response
# #regional_avg <- countryResults %>%
# #  group_by_at(.vars = c('Model','SuperRegion')) %>%
# #  summarise_at(3,mean,na.rm=T) %>%
# #  ungroup() #%>%
# 
# cResultslong <- countryResults %>%
#   group_by_at(.vars = c('Model','SuperRegion')) %>%
#   summarise_at(4:17,sum,na.rm=T) %>%
#   ungroup() %>%
#   arrange(desc(TotalResults)) %>%
#   group_by(Model) %>%
#  # slice(1:10) %>%
#   ungroup()%>%
#   filter(Model =='MMM') %>%
#   select(-c('TotalResults','TotalPct2_5','TotalPct97_5','Model')) 
# 
# cResultslong <- reshape2::melt(cResultslong, id="SuperRegion")
# cResultslong$Model.years <- strtoi(str_replace(cResultslong$variable, 'X',''))
# globalMMM <- globalResultslong[globalResultslong$Model == 'MMM - Mean AQS',]
# globalMMM$SuperRegion <- 'Global'
# globalMMM <- globalMMM %>%
#   select(-c('Model'))
# cResultslong <- rbind(cResultslong, globalMMM)
# 
# #cResultslong <- cResultslong %>%
# #  group_by_at(c("COUNTRY","Model.years")) %>%
# #  arrange(desc(value)) %>%
# #  mutate(COUNTRY = factor(COUNTRY, levels=c(
#     
#   reg_i <- cResultslong %>% 
#   group_by_at(.vars=c("SuperRegion")) %>% 
#   #filter(Model.years == 2020) %>%
#   summarize_at(.vars=c("value"),sum,na.rm=T) %>%
#   ungroup %>% arrange(desc(value)) %>%
#   distinct(SuperRegion)
# 
#   cResultslong <- cResultslong %>% 
#   mutate(SuperRegion = SuperRegion %>% factor(levels = (reg_i$SuperRegion))) %>%
#   arrange_at(.vars=c("SuperRegion"))
# 
# p3 <-  ggplot(cResultslong, aes(x=Model.years,
#                                 y=value,
#                                 colour=SuperRegion,
#                                 group=SuperRegion,
#                                 linetype=SuperRegion))+
#         geom_point()+
#         geom_line()+
#         scale_linetype_manual(values=c(rep("solid",9),"solid","solid"))+
#         scale_colour_manual(values=c("black",brewer.pal(7,"Spectral")))+
#         scale_size_manual(values=c(rep(1,5),1.5,1))+
#         xlab("Year")+ylab("Annual Attributable Respiratory-Related Mortality (deaths)")+
#         ggtitle('Annual Respiratory-Related Ozone Attributable Mortality (MMM), \nby GBD Super Region')+
#         theme_minimal()+
#         scale_x_continuous(breaks=seq(2020,2100,10))+
#         scale_y_continuous(limits=c(0,11500))
# p3
# 
# 
# 
# ### Extra 
# # stacked area chart or mortality by super region
# regsum <- countryResults %>%
#   filter(Model == 'MMM')%>%
#   select(SuperRegion, TotalResults) %>%
#   group_by_at(.vars = c('SuperRegion')) %>%
#   summarise_at(.vars=c("TotalResults"),sum,na.rm=F) %>% ungroup
# 
# regresp <- countryResults %>%
#   filter(Model == 'MMM')%>%
#   select(SuperRegion, AvgResponse) %>%
#   group_by_at(.vars = c('SuperRegion')) %>%
#   summarise_at(.vars=c("AvgResponse"),mean,na.rm=F) %>% ungroup
# 
# 
# 
# p4 <-  cResultslong %>%
#         filter(SuperRegion!='Global')%>%
#         ggplot( aes(x=Model.years,
#                                 y=value,
#                                 fill=SuperRegion,
#                                 group=SuperRegion))+
#         #geom_point()+
#         geom_area()+
#         #scale_linetype_manual(values=c(rep("solid",9),"solid","solid"))+
#         scale_fill_manual('GBD Super Regions',
#                           values=c(brewer.pal(7,"Spectral")))+
#         scale_size_manual(values=c(rep(1,5),1.5,1))+
#         xlab("Year")+ylab("Deaths")+
#         ggtitle('Annual Respiratory-Related Ozone Attributable Mortality (MMM), \nby GBD Super Region')+
#         theme_minimal()+
#         theme(legend.position = 'right')+ #c(0.7, 0.7))+
#         theme(axis.text = element_text(size=12),
#               axis.title = element_text(size=12),
#               axis.text.x=element_text(angle=45,hjust=1, vjust=1))+
#         scale_x_continuous(breaks=seq(2020,2100,10))+
#         scale_y_continuous(limits=c(0,11500), label = scales::comma)
#   
# p4
# ggsave(plot = p4, filename = 
#          file.path(Plots,'Timeseries_O3Mort_SuperRegion.png'),width = 10,height = 5)

```


##Figure S5

global maps of respiratory mortality, absolute total (by model)
```{r, countrymap}

## Figure 2b and adapted to S5

#map of country mortality results
MODEL = 'MMM'

Plots <- file.path(getwd(), 'analysis','Manuscript','Plots')
input <- file.path(getwd(),'input','BenMAP')
countryResults <- read.csv(paste0(input,"/Country Results Summary by Model & Year.csv"))

country_total <- countryResults %>%
  select(c('COUNTRY','Region','SuperRegion','Model','TotalResults','TotalPct2_5','TotalPct97_5')) %>%
  filter(Model == MODEL) %>%
  rename(region = COUNTRY) #%>%


# load map data and align country names
worldData <- map_data("world")
#correct region names
worldData["region"][worldData["region"] == "Russia"] <- "Russian Federation"
worldData["region"][worldData["region"] == "USA"] <- "United States"
worldData["region"][worldData["region"] == "Virgin Islands" & worldData['subregion']==' US'] <- "US Virgin Islands"
worldData["region"][worldData["region"] == "Taiwan"] <- "China, Taiwan Province of China"
worldData["region"][worldData["region"] == "Trinidad" | worldData['region']=='Tobago'] <- "Trinidad and Tobago"
worldData["region"][worldData["region"] == "Grenadines"| worldData['region']=='Saint Vincent'] <- "Saint Vincent and the Grenadines"
worldData["region"][worldData["region"] == "Swaziland"] <- "Eswatini"
worldData["region"][worldData["region"] == "UK"] <- "United Kingdom"
worldData["region"][worldData["region"] == "Cape Verde"] <- "Cabo Verde"
worldData["region"][worldData["region"] == "Republic of Congo"] <- "Congo"
worldData["region"][worldData["region"] == "Democratic Republic of the Congo"] <- "Congo DRC"
worldData["region"][worldData["region"] == "Ivory Coast"] <- "Cote d'Ivoire"
worldData["region"][worldData["region"] == "Brunei"] <- "Brunei Darussalam"
worldData["region"][worldData["region"] == "Antigua"| worldData['region']=='Barbuda'] <- "Antigua and Barbuda"
worldData["region"][worldData["region"] == "Palestine"] <- "Palestinian Territory"
worldData["region"][worldData["region"] == "China" & worldData['subregion']=='Hong Kong'] <- "China, Hong Kong SAR"
worldData["region"][worldData["region"] == "China" & worldData['subregion']=='Macao'] <- "China, Macao SAR"
worldData["region"][worldData["region"] == "Guernsey"| worldData['region']=='Jersey'] <- "Channel Islands"


#Merge data
MergedData <- left_join(worldData, country_total, by = 'region')
#replace zero with na
MergedData$TotalResults[MergedData$TotalResults ==0] <- NA

#chloropleth of world
p5 <- ggplot() +
  geom_polygon(data = MergedData, aes(x=long, y = lat, group=group, fill = TotalResults),
               color = 'black',linewidth=0.15)+
  scale_fill_fermenter("Total Deaths",
                       n.breaks=9,
                        type = 'seq',
                       direction = -1,
                        palette = "Spectral",
                        na.value='lightgray',
                       limits=c(0,100000),
                       breaks= c(0,100,1000,10000,100000),
                       label=scales::comma)+
  theme_void()+
  theme(legend.spacing.y = unit(.5,'cm'),
        legend.text = element_text(size=12),
        legend.title = element_text(size=13))+
  
  guides(col = guide_legend(override.aes = list(shape = 15, size = 10)))+
  coord_map(projection = 'mercator',xlim=c(-180,180),ylim = c(-55,80))

p5
ggsave(plot = p5, filename = 
         file.path(Plots,paste0('Total_MortMap_',MODEL,'.png')),width = 9,height = 5)
```

## Figures 2b and SXX

global maps of respiratory mortality, per capita (in 2020)
as well as maps of 2020 population, mortality rate, and average O3/CH4 response
```{r, countrymap_percapita}


#map of country mortality results
MODEL = 'MMM'

Plots <- file.path(getwd(), 'analysis','Manuscript','Plots')
input <- file.path(getwd(),'input')
countryResults <- read.csv(paste0(input,'/BenMAP',"/Country Results Summary by Model & Year.csv"))

country_2020 <- countryResults %>%
  select(c('COUNTRY','Region','SuperRegion','Model','AvgResponse','X2020')) %>%
  filter(Model == MODEL) %>%
  rename(region = COUNTRY) #%>%

#read in population
socio_inputs <- file.path('input','RFF','lookup_tables')
mean.pop<-read.csv(file.path(socio_inputs,"rff_pop_means.csv")) #this data set includes all countries (rff-sp does not)
mean.pop <- mean.pop %>%
  filter(Year ==2020) %>%
  mutate(mean_pop = mean_pop *1000) %>% #convert to ppl counts
  group_by(LocID) %>%
  summarise_at(.vars = c('mean_pop'), sum) 

#inputs3 <- file.path("Code","InputData","Tool Inputs")
Ctry.Name<-read.csv(file.path(input,'Final Country Grid Col_Row Index.csv'))

mean.pop <- mean.pop %>% left_join(Ctry.Name, by = c('LocID'='COL')) %>%
  select(-c('Region','SuperRegion'))
country_plot1 <- country_2020 %>% left_join(mean.pop, by =c('region'='COUNTRY')) %>%
  mutate(death_percap = 1e5*X2020/mean_pop) #absolute deaths per 100K

#read in mort data (created in the mortality timeseries chunk above)
mort_rate <- resp_mort_means_noage %>% 
  filter(Min.Year ==2020)
country_plot <- country_plot1 %>% left_join(mort_rate, by ='LocID')


# read in map data and align country names
worldData <- map_data("world")
#correct region names
worldData["region"][worldData["region"] == "Russia"] <- "Russian Federation"
worldData["region"][worldData["region"] == "USA"] <- "United States"
worldData["region"][worldData["region"] == "Virgin Islands" & worldData['subregion']==' US'] <- "US Virgin Islands"
worldData["region"][worldData["region"] == "Taiwan"] <- "China, Taiwan Province of China"
worldData["region"][worldData["region"] == "Trinidad" | worldData['region']=='Tobago'] <- "Trinidad and Tobago"
worldData["region"][worldData["region"] == "Grenadines"| worldData['region']=='Saint Vincent'] <- "Saint Vincent and the Grenadines"
worldData["region"][worldData["region"] == "Swaziland"] <- "Eswatini"
worldData["region"][worldData["region"] == "UK"] <- "United Kingdom"
worldData["region"][worldData["region"] == "Cape Verde"] <- "Cabo Verde"
worldData["region"][worldData["region"] == "Republic of Congo"] <- "Congo"
worldData["region"][worldData["region"] == "Democratic Republic of the Congo"] <- "Congo DRC"
worldData["region"][worldData["region"] == "Ivory Coast"] <- "Cote d'Ivoire"
worldData["region"][worldData["region"] == "Brunei"] <- "Brunei Darussalam"
worldData["region"][worldData["region"] == "Antigua"| worldData['region']=='Barbuda'] <- "Antigua and Barbuda"
worldData["region"][worldData["region"] == "Palestine"] <- "Palestinian Territory"
worldData["region"][worldData["region"] == "China" & worldData['subregion']=='Hong Kong'] <- "China, Hong Kong SAR"
worldData["region"][worldData["region"] == "China" & worldData['subregion']=='Macao'] <- "China, Macao SAR"
worldData["region"][worldData["region"] == "Guernsey"| worldData['region']=='Jersey'] <- "Channel Islands"


#Merge data
MergedData <- left_join(worldData, country_plot, by = 'region')
#replace zero with na
MergedData$death_percap[MergedData$death_percap ==0] <- NA
MergedData$AvgResponse[MergedData$AvgResponse ==0] <- NA
MergedData$MeanMortalityRate[MergedData$MeanMortalityRate ==0] <- NA
MergedData <- MergedData %>%
  mutate(rel_death_percap = death_percap/mean(death_percap, na.rm=TRUE),
         rel_AvgResponse = AvgResponse/mean(AvgResponse, na.rm=TRUE),
         rel_mean_pop = mean_pop/mean(mean_pop, na.rm=TRUE),
         rel_MeanMortalityRate = MeanMortalityRate/mean(MeanMortalityRate, na.rm=TRUE))


#chloropleth of world Per capita deaths
p5 <- ggplot() +
  geom_polygon(data = MergedData, aes(x=long, y = lat, group=group, fill = death_percap),
               color = 'black',linewidth=0.15)+
  scale_fill_fermenter("Deaths Per Capita",
                       n.breaks=10.5,
                        type = 'seq',
                       direction = -1,
                        palette = "Spectral",
                        na.value='lightgray',
                       #values=rescale(c(-1,0,1)),
                       limits=c(#0,
                                min(MergedData$death_percap, na.rm=TRUE),
                                0.3),
                       labels = c('Minimum',rep('',8),'Maximum'))+
  theme_void()+
  theme(legend.position = 'right')+
  theme(legend.key.height = unit(0.5,'cm'),
        legend.spacing.y = unit(.5,'cm'),
        legend.text = element_text(size=12),
        legend.title = element_text(size=13))+
  guides(col = guide_legend(override.aes = list(shape = 15, size = 10)))+
  coord_map(projection = 'mercator',xlim=c(-180,180),ylim = c(-55,80))

p5

#mortality rate
p6 <- ggplot() +
  geom_polygon(data = MergedData, aes(x=long, y = lat, group=group, 
                                      fill = MeanMortalityRate),
               color = 'black',linewidth=0.15)+
  scale_fill_fermenter("Respiratory Mortality Rates",
                       n.breaks=9,
                        type = 'seq',
                       direction = -1,
                        palette = "Spectral",
                        na.value='lightgray',
                       limits=c(min(MergedData$MeanMortalityRate, na.rm=TRUE),
                                max(MergedData$MeanMortalityRate, na.rm=TRUE)),
                       labels = c('Minimum','','','','','','Maximum'))+
  
  theme_void()+
  ggtitle("b) Respiratory Mortality Rates Per 100K")+
  theme(legend.position = 'none')+
  theme(legend.spacing.y = unit(.5,'cm'),
        legend.text = element_text(size=12),
        legend.title = element_text(size=13))+
  theme(plot.title = element_text(size = 20))+
  guides(col = guide_legend(override.aes = list(shape = 15, size = 10)))+
  coord_map(projection = 'mercator',xlim=c(-180,180),ylim = c(-55,80))
p6

#population
p7 <- ggplot() +
  geom_polygon(data = MergedData, aes(x=long, y = lat, group=group, fill = mean_pop),
               color = 'black',linewidth=0.15)+
  scale_fill_fermenter("Population",
                       n.breaks=9,
                        type = 'seq',
                       direction = -1,
                        palette = "Spectral",
                        na.value='lightgray',
                       limits=c(min(MergedData$mean_pop, na.rm=TRUE),
                                max(MergedData$mean_pop, na.rm=TRUE)),
                       #breaks= c(0,100,1000,5000,10000,20000,40000,60000,100000),
                       #breaks= c(0,100,1000,10000,100000),
                       #n.breaks = 6,
                       #label=scales::comma)+
                       labels = c('Minimum','','','','','','Maximum'))+
  theme_void()+
  ggtitle('a) Population')+
  theme(legend.position = 'none')+
  theme(legend.spacing.y = unit(.5,'cm'),
        legend.text = element_text(size=12),
        legend.title = element_text(size=13))+
  theme(plot.title = element_text(size = 20))+
  guides(col = guide_legend(override.aes = list(shape = 15, size = 10)))+
  coord_map(projection = 'mercator',xlim=c(-180,180),ylim = c(-55,80))
p7

#avg response
p8 <- ggplot() +
  geom_polygon(data = MergedData, aes(x=long, y = lat, group=group, fill = AvgResponse),
               color = 'black',linewidth=0.15)+
  scale_fill_fermenter("",
                       n.breaks=9,
                        type = 'seq',
                       direction = -1,
                        palette = "Spectral",
                        na.value='lightgray',
                       limits=c(min(MergedData$AvgResponse, na.rm=TRUE),
                                max(MergedData$AvgResponse, na.rm=TRUE)),
                       labels = c('Minimum','','','','','','Maximum'))+
  theme_void()+
  ggtitle(expression(paste('c) Average Ozone Response (pptv ', O[3],"/", "ppbv ",CH[4],')')))+
  theme(legend.position = 'bottom')+
  theme(legend.key.width = unit(2,'cm'),
        legend.text = element_text(size=12),
        legend.title = element_text(size=13))+
  theme(plot.title = element_text(size = 20))+
  coord_map(projection = 'mercator',xlim=c(-180,180),ylim = c(-55,80))
p8

p<- p7+p6+p8
p <-p+plot_annotation(title = "",
                        theme = theme(plot.title = element_text(size = 20)))+
      plot_layout(ncol = 1)
p

ggsave(plot = p, filename = 
         file.path(Plots,paste0('Relative_2020_CombMaps_',MODEL,'.png')),width = 9,height = 15)

ggsave(plot = p5, filename = 
         file.path(Plots,paste0('Relative_2020_DeathsPerCapMaps_',MODEL,'.png')),width = 9,height = 5)
```


## Figure 2c and SX

barchart of NPD values by region, central case and by discount rate
```{r, damagesbar}

Plots <- file.path(getwd(), 'analysis','Manuscript','Plots')
inputs <- file.path(getwd(),'analysis','Manuscript','BenMAP','Outputs')
countryresults <-
   read_csv(file.path(inputs,"npd_country_damage_transformation_woutCessation.csv"),
           col_types = cols())

globalresults <-
  read_csv(file.path(inputs, "npd_global_damage_transformation_woutCessation.csv"),
           col_types = cols())

globalresults <- 
  globalresults  %>%
  group_by_at(.vars = c('Model','discount.rate')) %>%
  arrange(desc(mean)) %>%
  filter(Model =='MMM') %>%
  mutate(SuperRegion = 'Global')%>%
  filter(discount.rate %in% 
           c('1.5% Ramsey', '2.0% Ramsey', '2.5% Ramsey', "3.0% Ramsey",'2.0% CDR','3.0% CDR'))

cResultslong <- countryresults %>%
  group_by_at(.vars = c('Model','SuperRegion','discount.rate')) %>%
  summarise_at(c('mean','2.5%','97.5%'),sum,na.rm=T) %>%
  ungroup() %>%
  arrange(desc(mean)) %>%
  filter(Model =='MMM') %>%
  rbind(globalresults)

## ordering of central rate for alpha transparency
cResultslong$discount.rate <- factor(cResultslong$discount.rate, 
                                  levels=c('3.0% CDR','2.0% CDR',
                                          "3.0% Ramsey","2.5% Ramsey", 
                                          "2.0% Ramsey", "1.5% Ramsey" ))

## function for labels
means = cResultslong %>% 
  group_by_at(c('discount.rate','SuperRegion')) %>% 
  summarise(means=mean) %>% 
  ungroup() %>%
  mutate(across(c('means'), ~ signif(.,3)))

lower = cResultslong %>% 
  group_by_at(c('discount.rate','SuperRegion')) %>% 
  summarise(means=`2.5%`) %>% 
  ungroup() %>%
  mutate(across(c('means'), ~ signif(.,3)))

upper = cResultslong %>% 
  group_by_at(c('discount.rate','SuperRegion')) %>% 
  summarise(means=`97.5%`) %>% 
  ungroup() %>%
  mutate(across(c('means'), ~ signif(.,3)))

    
  reg_i <- cResultslong %>% 
  group_by_at(.vars=c("SuperRegion")) %>% 
  summarize_at(.vars=c("mean"),sum,na.rm=T) %>%
  ungroup %>% arrange((mean)) %>%
  distinct(SuperRegion)

  cResultslong <- cResultslong %>% 
  mutate(SuperRegion = SuperRegion %>% factor(levels = (reg_i$SuperRegion))) %>%
  arrange_at(.vars=c("SuperRegion"))
  
  # Figure SX
  
  p1 <-  ggplot(cResultslong, aes(x=SuperRegion, y=mean))+
        geom_linerange(aes(x=SuperRegion,ymin=`2.5%`, ymax=`97.5%`,group=discount.rate),
                       color = 'lightgray',size=1,
                       position = position_dodge(0.8))+
        geom_point(aes(color = discount.rate), position = position_dodge(0.8),size=2)+
        coord_flip()+
        scale_color_brewer('Discount Rate',palette = 'Spectral',direction=-1)+
        scale_x_discrete(labels = function(x) str_wrap(x,width=30))+
        scale_y_continuous(limits=c(0,3000), label = scales::dollar)+
        xlab("")+ylab("$(2020)/mT" ~CH[4])+
        ggtitle(paste0('Net Present Damages per metric ton methane \nby GBD Super Region'))+
        theme_minimal()+
        theme(legend.position = c(0.7,0.4),
              legend.title=element_text(size=16), 
              legend.text=element_text(size=16))+
        theme(axis.text = element_text(size=16),
              axis.title = element_text(size=16))
# Figure 2c
p2 <-  cResultslong %>%
        filter(discount.rate == '2.0% Ramsey') %>%
        ggplot(aes(x=SuperRegion, y=mean,fill = SuperRegion))+
        geom_bar(stat = 'identity', position = 'dodge',width=0.6)+
        geom_pointrange(aes(x=SuperRegion,ymin=`2.5%`, ymax=`97.5%`),
                        position = position_dodge(width=0.2),size=0.3,alpha=0.8)+#errobar,width = 0.4)+
        coord_flip()+
        scale_fill_brewer(palette = 'Spectral',direction=-1)+
        scale_x_discrete(labels = function(x) str_wrap(x,width=30))+
        scale_y_continuous(limits=c(0,3000), label = scales::dollar)+
        xlab("")+ylab("$(2020)/mT" ~CH[4])+
        ggtitle(paste0('Damages per metric ton methane \nby GBD Super Region'))+
        theme_minimal()+
        theme(legend.position = 'none')+#c(0.7,0.3))+
        theme(axis.text = element_text(size=16),
              axis.title = element_text(size=16))+
        geom_text(data=means%>%filter(discount.rate == '2.0% Ramsey'),
            aes(y=means, x=SuperRegion,
                label=paste0('$', round(means, 2)), vjust=-0.35,hjust = -0.35),
            color    = 'grey20',
            size     = 6)
p2

ggsave(plot = p1, filename = 
         file.path(Plots,'npd_country_bar_discount.png'),width = 10,height = 5)
ggsave(plot = p2, filename = 
         file.path(Plots,'Fig2c.png'),width = 10,height = 5)

```



Extra
```{r globaldiscountbars}

# #create bar graph of damages by region
# Plots <- file.path(getwd(), 'analysis','Manuscript','Plots')
# inputs <- file.path(getwd(),'analysis','Manuscript','BenMAP','Outputs')
# countryresults <-
#    read_csv(file.path(inputs,"npd_country_damage_transformation_woutCessation.csv"),
#            col_types = cols())
# 
# globalresults <-
#   read_csv(file.path(inputs, "npd_global_damage_transformation_woutCessation.csv"),
#            col_types = cols())
# 
# Results <- file.path('Results')
# globalresults <-
#   read_csv(file.path(Results,"npd_global_damage_transformation_woutCessation.csv"),
#            col_types = cols())
# 
# globalresults <- 
#   globalresults  %>%
#   group_by_at(.vars = c('Model','discount.rate')) %>%
#   arrange(desc(mean)) %>%
#   filter(Model =='MMM') %>%
#   mutate(SuperRegion = 'Global')%>%
#   filter(discount.rate %in% 
#            c('1.5% Ramsey', '2.0% Ramsey', '2.5% Ramsey', "3.0% Ramsey",'2.0% CDR','3.0% CDR'))
# 
# ## ordering of central rate for alpha transparency
# globalresults$discount.rate <- factor(globalresults$discount.rate, 
#                                   levels=c('3.0% CDR','2.0% CDR',
#                                           "3.0% Ramsey","2.5% Ramsey", 
#                                           "2.0% Ramsey", "1.5% Ramsey" ))
# 
# 
# ## function for labels
# means = globalresults %>% 
#   group_by(discount.rate) %>% 
#   summarise(means=mean) %>% 
#   mutate(across(c('means'), ~ signif(.,3)))
# 
# 
# 
# p1 <-  ggplot(globalresults, aes(x=discount.rate, y=mean))+
#         geom_point(stat = 'identity')+
#         geom_pointrange(aes(x=discount.rate,ymin=`2.5%`, ymax=`97.5%`),size=0.3,alpha=0.8)+#errobar,width = 0.4)+
#         coord_flip()+
#         scale_fill_brewer(palette = 'Spectral',direction=-1)+
#         scale_x_discrete(labels = function(x) str_wrap(x,width=30))+
#         scale_y_continuous(limits=c(500,3500), label = scales::dollar)+
#         #scale_linetype_manual(values=c(rep("solid",9),"solid","solid"))+
#         #scale_colour_manual(values=c("black",brewer.pal(7,"Spectral")))+
#         #scale_size_manual(values=c(rep(1,5),1.5,1))+
#         xlab("")+ylab("$(2020)/mT" ~CH[4])+
#         ggtitle(paste0('Global NPD per metric ton methane'))+
#         theme_minimal()+
#         theme(legend.position = 'none')+
#         theme(axis.text = element_text(size=16),
#               axis.title = element_text(size=16))+
#         geom_text(data=means, 
#             aes(y=means, x=discount.rate, group=discount.rate, 
#                 label=paste0('$', round(means, 2)), vjust=-1.5),
#             #position = position_dodge(1.3),
#             color    = 'grey20',
#             size     = 4) 
#         #scale_x_continuous(breaks=seq(2020,2100,10))
#         #scale_y_continuous(limits=c(0,11500))
# p1
# 
# ggsave(plot = p1, filename = 
#          file.path(Results,'Global BenMAP WebTool','Plots','Global_NPD_by_discounting.png'),width = 10,height = 5)

```
## Figure 3

Tornado sensitivity plot
```{r tornado}

#create a tornado plot with npd results from:
#1. different GCMs (created from monetization code?)
#2. BenMAP (created from monetization code?)
#3. Discounting (created from monetization code)
#3. BenMAP socioeconomic scenarios (from methane-ozone RFT)
#4. NOx (**)


#Read in 
Plots <- file.path(getwd(), 'analysis','Manuscript','Plots')
inputs <- file.path(getwd(),'analysis','Manuscript','BenMAP','Outputs')
rft_inputs <- file.path(getwd(),'output','npd')

Results <- file.path('Results')
globalresults <-
  read_csv(file.path(inputs,"npd_global_damage_transformation_woutCessation.csv"),
           col_types = cols())
Results2 <- file.path(rft_inputs,'npd_global_rff_means_NOx_1_MMM.csv')
rft_results <- read_csv(Results2, col_types = cols())
nox_results1 <- file.path(rft_inputs,'npd_global_rff_means_NOx_1_MMM.csv')
nox_results1 <- read_csv(nox_results1, col_types = cols())%>%
  mutate(NOx = '1')
nox_results5 <- file.path(rft_inputs, 'npd_global_rff_means_NOx_0.5_MMM.csv')
nox_results5 <- read_csv(nox_results5, col_types = cols())%>%
  mutate(NOx = '0.5')
nox_results15 <- file.path(rft_inputs, 'npd_global_rff_means_NOx_1.5_MMM.csv')
nox_results15 <- read_csv(nox_results15, col_types = cols()) %>%
  mutate(NOx = '1.5')
nox_total_results <- rbind(nox_results1,nox_results5,nox_results15)



#cols: Group, Sub-Group, Min, Max, Mean
group_col <- c(rep("CRF (95% CI)",2),rep("GCM (mean)",5),rep("Socioeconomics (95% CI)",2),
                          rep("Discount Rate (mean)",5),rep('NOx Emissions (\u0394 50%)',2))
subgroup_col <- (c("CRF Upper","CRF Lower","HadGEM","CESM2","MIROC","GISS","GFDL","SocioEcon. Upper","SocioEcon. Lower",
                  "1.5% Ramsey","2.5% Ramsey","3.0% Ramsey","2.0% CDR",'3.0% CDR','-50% NOx','+50% NOx'))
val_col <- c(globalresults$`97.5%`[globalresults$Model=='MMM' & globalresults$discount.rate=='2.0% Ramsey'],
             globalresults$`2.5%`[globalresults$Model=='MMM' & globalresults$discount.rate=='2.0% Ramsey'],
             globalresults$mean[globalresults$Model=='HadGEM' & globalresults$discount.rate=='2.0% Ramsey'],
             globalresults$mean[globalresults$Model=='CESM2' & globalresults$discount.rate=='2.0% Ramsey'],
             globalresults$mean[globalresults$Model=='MIROC' & globalresults$discount.rate=='2.0% Ramsey'],
             globalresults$mean[globalresults$Model=='GISS' & globalresults$discount.rate=='2.0% Ramsey'],
             globalresults$mean[globalresults$Model=='GFDL' & globalresults$discount.rate=='2.0% Ramsey'],
             rft_results$npd_97.5_wlag[rft_results$discount.rate=='2.0% Ramsey'],
             rft_results$npd_2.5_wlag[rft_results$discount.rate=='2.0% Ramsey'],
             globalresults$mean[globalresults$Model=='MMM' & globalresults$discount.rate=='1.5% Ramsey'],
             #globalresults$mean[globalresults$Model=='MMM' & globalresults$discount.rate=='2.0% Ramsey'],
             globalresults$mean[globalresults$Model=='MMM' & globalresults$discount.rate=='2.5% Ramsey'],
             globalresults$mean[globalresults$Model=='MMM' & globalresults$discount.rate=='3.0% Ramsey'],
             globalresults$mean[globalresults$Model=='MMM' & globalresults$discount.rate=='2.0% CDR'],
             globalresults$mean[globalresults$Model=='MMM' & globalresults$discount.rate=='3.0% CDR'],
             nox_total_results$mean_npd[nox_total_results$NOx=='0.5' & nox_total_results$discount.rate=='2.0% Ramsey'],
             nox_total_results$mean_npd[nox_total_results$NOx=='1.5' & nox_total_results$discount.rate=='2.0% Ramsey']
             )

#calculate the absolute difference
val_col <- val_col - globalresults$mean[globalresults$Model=='MMM' & globalresults$discount.rate=='2.0% Ramsey']

plot_data <- data.frame(group_col, subgroup_col, val_col)

p1 <- plot_data %>%
  mutate(subgroup_col = (fct_relevel(subgroup_col, '3.0% CDR',
                                     "2.0% CDR","3.0% Ramsey",
                                     "2.5% Ramsey","1.5% Ramsey",
                                     "MIROC","GISS","GFDL",
                                     "CESM2","HadGEM",
                                     '-50% NOx','+50% NOx',
                                     "SocioEcon. Lower","SocioEcon. Upper",
                                     "CRF Lower","CRF Upper"
                                     ))) %>%
  ggplot( aes(x=(subgroup_col), y=(val_col),fill=group_col))+
  geom_bar(stat='identity',width = 0.4)+
  #scale_fill_brewer() (palette = 'Spectral',direction=-1)+
  scale_fill_manual(name = '',values=c(brewer.pal(11,"Spectral")[c(2,4,8,10,11)]),
  breaks= c('CRF (95% CI)','Socioeconomics (95% CI)','NOx Emissions (\u0394 50%)','GCM (mean)','Discount Rate (mean)'))+
  coord_flip()+
  theme_minimal()+
  xlab('')+
  ylab("Change in Global $1660(2020)/mT" ~CH[4])+
  theme(axis.text = element_text(size=16),
        axis.title = element_text(size=16))+
  scale_y_continuous(limits = c(-1000, 1300),label = scales::dollar)+
  theme(legend.position = c(0.8,0.25),
        legend.title=element_text(size=14), 
        legend.text=element_text(size=14))

p1

ggsave(plot = p1, filename = 
         file.path(Plots,'Fig3.png'),width = 10,height = 5)

```

